<?php
/**
 * Скрипт для генерации тестовых отзывов
 * Запуск: wp eval-file generate-test-reviews.php
 * или через браузер: /wp-content/plugins/wordpress-reviews-plugin/generate-test-reviews.php
 */

// Если запускается напрямую через браузер
if (!defined('ABSPATH')) {
    // Подключаем WordPress
    require_once('../../../wp-load.php');
}

// Тестовые данные
$cities = ['Москва', 'Санкт-Петербург', 'Казань', 'Новосибирск', 'Екатеринбург', 'Нижний Новгород', 'Краснодар', 'Челябинск'];
$products = ['Кухня', 'Шкаф-купе', 'Гардеробная', 'Спальня', 'Гостиная', 'Детская', 'Прихожая', 'Офисная мебель'];
$years = ['2024', '2023', '2022', '2021'];
$names = ['Анна', 'Иван', 'Мария', 'Дмитрий', 'Елена', 'Сергей', 'Ольга', 'Александр', 'Наталья', 'Андрей', 'Татьяна', 'Павел'];

$review_texts = [
    'Отличное качество, все сделано в срок. Очень доволен результатом!',
    'Прекрасная работа мастеров. Мебель получилась именно такой, как я хотела.',
    'Рекомендую! Качество на высшем уровне, цена соответствует.',
    'Очень довольна покупкой. Все детали продуманы, сборка качественная.',
    'Отличный сервис и результат. Мебель выглядит дорого и стильно.',
    'Все сделано быстро и качественно. Осталась очень довольна!',
    'Прекрасное качество материалов и исполнения. Рекомендую всем!',
    'Очень доволен результатом. Мебель превзошла все ожидания.',
    'Отличная работа! Все детали на месте, сборка профессиональная.',
    'Качество на высоте! Мебель выглядит дорого и служит уже год без проблем.',
    'Очень довольна! Все сделано аккуратно и в срок.',
    'Прекрасный результат. Мебель идеально вписалась в интерьер.',
    'Отличное качество и сервис. Рекомендую эту компанию!',
    'Все на высшем уровне! Очень доволен покупкой.',
    'Качество превосходное, цена адекватная. Осталась очень довольна!',
    'Отличная работа мастеров. Мебель получилась именно такой, как планировали.',
    'Прекрасное качество и внимание к деталям. Рекомендую!',
    'Очень доволен результатом. Все сделано профессионально.',
    'Качество на высоте! Мебель служит уже полгода без нареканий.',
    'Отличный сервис и результат. Осталась очень довольна!',
    'Прекрасная работа! Все детали продуманы, сборка качественная.',
    'Очень довольна покупкой. Мебель выглядит дорого и стильно.',
    'Отличное качество материалов. Рекомендую всем!',
    'Все сделано быстро и качественно. Осталась очень довольна!',
    'Прекрасное качество и исполнение. Мебель превзошла ожидания.',
    'Очень доволен результатом. Все детали на месте.',
    'Отличная работа! Качество на высшем уровне.',
    'Качество на высоте! Мебель идеально вписалась в интерьер.',
    'Отличный сервис. Рекомендую эту компанию!',
    'Все на высшем уровне! Очень доволен покупкой.'
];

// Функция для получения случайного изображения из медиатеки или создания placeholder
function get_random_image_id() {
    $args = array(
        'post_type' => 'attachment',
        'post_mime_type' => 'image',
        'posts_per_page' => 1,
        'orderby' => 'rand',
        'post_status' => 'inherit'
    );
    
    $images = get_posts($args);
    if (!empty($images)) {
        return $images[0]->ID;
    }
    
    // Если нет изображений, создаем placeholder через API
    // Для простоты вернем null - тогда будет использоваться featured image
    return null;
}

// Создаем 30 отзывов
$created = 0;
$errors = 0;

for ($i = 1; $i <= 30; $i++) {
    $city = $cities[array_rand($cities)];
    $product = $products[array_rand($products)];
    $year = $years[array_rand($years)];
    $name = $names[array_rand($names)];
    $review_text = $review_texts[array_rand($review_texts)];
    
    // Создаем заголовок
    $title = "Отзыв от {$name} из {$city}";
    
    // Создаем пост
    $post_data = array(
        'post_title'    => $title,
        'post_content'  => $review_text,
        'post_status'   => 'publish',
        'post_type'     => 'review',
        'post_date'     => date('Y-m-d H:i:s', strtotime("-" . rand(0, 365) . " days")),
    );
    
    $post_id = wp_insert_post($post_data);
    
    if (is_wp_error($post_id)) {
        $errors++;
        continue;
    }
    
    // Устанавливаем метаполя
    update_post_meta($post_id, '_reviewer_name', $name);
    update_post_meta($post_id, '_review_city', $city);
    update_post_meta($post_id, '_review_year', $year);
    update_post_meta($post_id, '_review_product', $product);
    update_post_meta($post_id, '_product_name', $product);
    
    // Случайно добавляем видео (30% вероятность)
    if (rand(1, 10) <= 3) {
        update_post_meta($post_id, '_review_has_video', '1');
        update_post_meta($post_id, '_review_video_url', 'https://www.youtube.com/watch?v=dQw4w9WgXcQ');
    }
    
    // Пытаемся найти изображения для галереи
    $gallery_ids = array();
    $image_count = rand(1, 5); // От 1 до 5 изображений в галерее
    
    for ($j = 0; $j < $image_count; $j++) {
        $img_id = get_random_image_id();
        if ($img_id) {
            $gallery_ids[] = $img_id;
        }
    }
    
    // Если нашли изображения, добавляем в галерею
    if (!empty($gallery_ids)) {
        update_post_meta($post_id, '_review_gallery', implode(',', $gallery_ids));
        // Устанавливаем первое изображение как featured image
        set_post_thumbnail($post_id, $gallery_ids[0]);
    } else {
        // Если нет изображений в медиатеке, создаем placeholder через API
        // Для простоты оставляем без изображения или можно использовать дефолтное
    }
    
    $created++;
}

// Выводим результат
if (defined('WP_CLI')) {
    WP_CLI::success("Создано отзывов: {$created}, ошибок: {$errors}");
} else {
    echo "<h1>Генерация тестовых отзывов завершена</h1>";
    echo "<p>Создано отзывов: <strong>{$created}</strong></p>";
    echo "<p>Ошибок: <strong>{$errors}</strong></p>";
    echo "<p><a href='" . admin_url('edit.php?post_type=review') . "'>Перейти к списку отзывов</a></p>";
}

